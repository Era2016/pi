<?php
$this->jQuery('extension/fileupload-min.js');
$this->css($this->assetModule('script/front.css'));
$this->Backbone();
?>

<div id="draft-page" class="row">
    <?php
        $form->prepare();
        $form->setAttribute('class', 'form-horizontal');
        $form->setAttribute('enctype', 'multipart/form-data');
        echo $this->form()->openTag($form);
    ?>
    <div id="jsBasicInput" class="col-md-8">
        <a href="#" target="_blank" class="hide hide-preview"></a>
    <?php 
        // Move some element (i.e.: time publish, featured image, gallery, related article) to right side
        $timePublishElement = $form->get('time_publish');
        $form->remove('time_publish');
        $imageElement = $relatedElement = '';
        if ($form->has('related-related')) {
            $relatedElement = $form->get('related-related');
            $form->remove('related-related');
        }
        if ($form->has('image')) {
            $imageElement = $form->get('image');
            $form->remove('image');
        }
        if ($form->has('gallery')) {
            $galleryElement = $form->get('gallery');
            $form->remove('gallery');
        }
        include $this->templateModule('article:component/form');
    ?>
    </div>
    <div class="col-md-4">
        <!-- Start article management block -->
        <div class="widget" id="jsReleaseProcess">
            <div class="widget-header">
                <?php _e('Status:'); ?>
                <strong class="status">
                    <?php if (isset($draft['article']) and $draft['article']) {
                         _e('Published'); 
                    } else {
                        $draftStatus = isset($draft['status']) ? $draft['status'] : 0;
                        switch ($draftStatus) {
                            case 1: _e('Draft');
                                break;
                            case 2: _e('Pending');
                                break; 
                            case 3: _e('Rejected');
                    ?>
                    <i class="icon-question-sign" id="jsReject" data-content="
                        <?php 
                            echo isset($draft['reject_reason']) 
                                ? _escape($draft['reject_reason']) : '' 
                        ?>" data-placement="bottom">
                    </i>
                    <script>
                    (function($) {
                        var el = $("#jsReject");
                        el.popover({
                            title : "Reject reason <span class='close'>×</span>",
                            html  : true
                        });
                        setTimeout(function() {
                            el.popover("show").data("popover").$tip.on("click", ".close", function() {
                                el.popover("hide");
                            });
                        }, 10);
                    })(jQuery)
                    </script>
                    <?php         
                                break;    
                            default: _e('Draft');
                                break;
                        }
                    } ?>
                </strong>
            </div>
            <div class="widget-body">
                <div class="clearfix article-flow">
                     <span class="pull-right btn btn-default preview" data-src=""><?php _e('Preview'); ?></span>
                     <?php if (!$draft['article']) { ?>
                     <span class="btn btn-info save"><?php _e('Save'); ?></span>
                     <?php } ?>
                </div>
                <div class="article-flow" style="padding-top: 10px;">
                    <span class="publish-time-edit">
                        <?php if ($draft['time_publish']) { ?>
                            <?php _e('Scheduled at'); ?>
                        <strong><?php echo _date($draft['time_publish']); ?></strong>
                        <?php } else { 
                            _e('publish immediately');
                        } ?>
                    </span>
                    <span class="link-btn edit-time"><?php _e('Edit'); ?></span>
                    <span class="link-btn save-time mr10"><?php _e('Save'); ?></span>
                    <span class="link-btn cancel-time"><?php _e('Cancel'); ?></span>
                    <div class="clearfix time-edit-wrap hide"><?php echo $this->formElement($timePublishElement); ?></div>
                    <p>
                    <?php 
                        if ($draft['time_save']) {
                            echo sprintf(
                                __('Last edit at %s by %s'), _date($draft['time_save']), (isset($userUpdate) ? $userUpdate['name'] : $user['name'])
                            );
                        }
                    ?> 
                    </p>
                </div>
                <div id="article-management-operation" class="clearfix" style="margin-top: 10px;">
                    <?php if ($draft['article']) { ?>
                    <button class="btn btn-primary pull-right update"><?php _e('Update'); ?></button>
                    <?php } elseif ($draft['status'] == 2) { ?>
                    <?php if (isset($currentApprove) and $currentApprove) { ?>
                        <div class="btn-group pull-right">
                            <button class="btn btn-primary approve"><?php _e('Approve'); ?></button>
                            <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a href="javascript:void(0)" data-target="#rejectModel" data-toggle="modal" data-backdrop="false">
                                        <?php _e('Reject'); ?>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    <?php } ?>
                    <?php } else { ?>    
                    <button class="btn btn-primary pull-right pending"><?php _e('Submit'); ?></button>
                    <?php } ?>
                    <?php if (isset($currentDelete) and $currentDelete) { ?>
                        <span class="link-btn delete"><?php _e('Delete'); ?></span>
                    <?php } ?>
                </div>
                <div id="rejectModel" class="modal fade">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                <h4 class="modal-title"><?php _e('Reject reason'); ?></h4>
                            </div>
                            <div class="modal-body" style="height: 100px">
                                <textarea class="col-md-12 form-control memo"></textarea>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary reject" data-dismiss="modal"><?php _e('Reject'); ?></button>
                            </div>
                        </div>
                    </div>  
                </div>
            </div>
        </div>
        <!-- End article management block -->
        
        <!-- Start featured image management block -->
        <?php if ($form->has('image')) { ?>
        <div class="widget" id="jsUpload">
            <div class="widget-header">
                <strong><?php _e('Feature image'); ?></strong>
            </div>
            <div class="clearfix widget-body">
                <?php echo $this->formElement($imageElement); ?>
            </div>
        </div>
        <?php } ?>
        <!-- End featured image management block -->
        
        <!-- Start gallery management block -->
        <?php if ($form->has('gllary')) { ?>
        <div class="widget" id="jsGallery">
            <div class="widget-header" style="cursor: pointer;" title="<?php _e('Click toggle show'); ?>">
                <i class="icon-caret-up fa fa-chevron-up"></i>
                <i class="icon-caret-down fa fa-chevron-down"></i>
                <strong><?php _e('Image gallery'); ?></strong>
            </div>
            <div class="widget-body" style="padding-right: 0; display: inline-block; width: 100%;">
                <?php echo $this->formElement($galleryElement); ?>
            </div>
        </div>
        <?php } ?>
        <!-- End gallery management block -->
        
        <!-- Start related article management block -->
        <?php
            if ($relatedElement) {
        ?>
        <div class="widget" id="jsRelated">
            <div class="widget-header">
                <strong><?php _e('Related articles'); ?></strong>
            </div>
            <div class="widget-body"><?php echo $this->formElement($relatedElement); ?></div>
        </div>
        <?php } ?>
        <!-- End related article management block -->
        
    </div>
    <?php echo $this->form()->closeTag(); ?>
</div>
       
<script id="temp-validate" type="text/template">
    <div class="col-md-12">
        <div class="col-md-12 alert <% if (status) { %>alert-success<% } else { %>alert-danger<% } %>" id="jsAlert">
            <button type="button" class="close" data-dismiss="alert">×</button>
            <% if (!_.isEmpty(message)) { %>
            <% if (_.isString(message)) { %>
                <%= message %>
                <% if (status) { %>
                <a href="<?php echo $this->url('', array('controller' => 'draft' ,'action'=>'add')); ?>">
                    <?php _e('Add a new article'); ?>
                </a>
                <% } %>
            <% } else { %>    
            <% _.each(message,function(first,key1) { %>
                <strong><%= key1 %>:</strong>
                <div>
                <% _.each(message[key1],function(second,key2) { %>
                    <span class="mr10"><%= message[key1][key2] %></span>
                <% }); %>
                </div>
            <% }); %>
            <% }} %>
        </div>
    </div>
</script>

<script>
var obj;
var currentStatus;
var response;
(function($) {
var page = {
    id      : "<?php echo $form->get('id')->getValue() ?: 'none'; ?>",
    base    : "<?php echo Pi::url(''); ?>",
    status  : "<?php echo $this->escape($draft['status']); ?>",
    form    : $("form#draft"),
    from    : "<?php echo isset($from) ? $this->escape($from) : ''; ?>",
    init    : function () {
        this.jump = this.$("[name=jump]");
        <?php if (!$draft['article']) { ?>
        if (this.autosaveInterval > 0) {
            setInterval(function() {
                if ($.trim(this.$("[name=subject]").val()) 
                    || $.trim(this.$("#content").val())
                ) {
                    page.submit({msg:false});
                }
            }, this.autosaveInterval * 1000 * 60);
        }
        <?php } ?>
        this.timer = setInterval(_.bind(this.loadSaveTime,this), 100);
        $("#jsUploadModel").on("click", ".close-all", function() {
             $("#jsUploadModel").hide();
        });
        page.form.submit(function(e) {
            e.preventDefault();
        });
        this.navChange();
    },
    $       : function(selector) {
        return this.form.find(selector);
    },
    submit  : function(arg) {
        var option = {
            url     : "<?php echo $this->url('', array('action' => 'save')); ?>",
            msg     : true,
            fn      : function(){},
            fail    : function(){}
        };
        option = _.extend(option,arg);
        this.$("[name=content]").val(this.editor.getData());
        this.$("select:disabled").removeAttr("disabled");
        $.post(option.url, this.form.serialize()).done(function (resp) {
            resp = $.parseJSON(resp);
            if (resp.status == 1) {
                option.msg && page.formTip(resp);
                page.autoSaveTime();
                if (resp.data) {
                    if (resp.data.redirect) {
                        setTimeout(function() {
                            history.go(-1);
                        },200)
                    } else {
                        page.$("[name=id]").val(resp.data.id);
                        page.id = resp.data.id;
                    }
                }
                option.fn(resp.data);
            } else {
                page.formTip(resp);
                option.fail(resp.data);
            }
        });
    },
    editor:             CKEDITOR.instances.content,
    autosaveInterval:   '<?php echo $this->escape($autoSave); ?>',
    autoSaveTime:       function() {
        var i=0;
        $(".auto-save-time").html("Draft saved just now");
        clearInterval(this.saveInterval);
        this.saveInterval=setInterval(function(){
            $(".auto-save-time").html("Draft saved at "+(++i)+" minute ago");
        },1000*60);
    },
    formTip : function(resp) {
        $("#jsAlert").remove();
        $(_.template($("#temp-validate").html(),resp)).insertBefore(page.form);
    },
    loadSaveTime    : function() {
        if (this.editor.container) {
            var c = this.editor.container;
            $(c.$).css("max-width","100%");
            c.appendHtml('<div class="auto-save-bg"><span class="auto-save-time"></span></div>');
            clearInterval(this.timer);
        }
    },
    showUploadModel : function(obj) {
        $("#jsUploadModel").html(_.template($("#temp-upload-model").html(),obj)).show();
    },
    getUrlParam     : function(param) {
        var src= location.href;
        if (!/^.+\?(.+)$/.test(src)) return "";
        var ret = {},
            s   = src.replace( /^.+\?(.+)$/, "$1"),
            arr = s.split("&"),
            i   = 0,
            l   = arr.length;
        for (; i < l; i++) {
            ret[arr[i].replace(/\=.+/, "")] = arr[i].replace(/.+\=/, "");
        }
        return ret[param] || "";
    },
    navChange       : function() {
        if (this.from=="all") {
            $(".nav-tabs:first").find(">").removeClass("active").eq(0).addClass("active");
        }
    }
};
var BasicInputView = Backbone.View.extend({
    el      : $("#jsBasicInput"),
    events  : {
        "blur [name=subject]"       : "checkSubject",
        "change [name=category]"    : "checkOperation"
    },
    initialize: function () {
        _.bindAll(this);
    },
    checkSubject    : function(e) {
        var tar = $(e.currentTarget).removeClass("error");
        $.getJSON("<?php echo $this->url(
            'default',
            array('controller' => 'article', 'action' => 'check.article.exists')
        ); ?>", {
            subject : $.trim(tar.val()),
            id      : page.$("[name=article]").val()
        }).done(function(resp) {
            if (resp.status) {
                $("#jsAlert").remove(); 
            } else {
                page.formTip(resp);
            }
        });
    },
    checkOperation  : function(e) {
        var approve = '<?php echo implode(',', $approve); ?>';
        var approves = new Array();
        approves = approve.split(',');
        var category = $(this).val();
        var allowed = false;
        for (i = 0; i < approves.length; i++) {
            if (category == approves[i]) {
                allowed = true;
            }
        }
        var prevStatus = '<?php echo $status ?>';
        var content = '';
        if ($('span.link-btn.delete').length) {
            content = '<span class="link-btn delete" style="display: block;">Delete</span>';
        }
        if ((1 == prevStatus || 3 == prevStatus) && 2 == currentStatus) {
            if (allowed) {
                content = '<button class="btn btn-primary pull-right approve">Approve</button>' + content;
            }
            $('#article-management-operation').html(content);
        } else if (2 == prevStatus) {
            if (allowed) {
                content = '<div class="btn-group pull-right">'
                        + '<button class="btn btn-primary approve"><?php _e('Approve'); ?></button>'
                        + '<button class="btn btn-primary dropdown-toggle" data-toggle="dropdown">'
                        + '<span class="caret"></span>'
                        + '</button>'
                        + '<ul class="dropdown-menu"><li>'
                        + '<a href="javascript:void(0)" data-target="#rejectModel" data-toggle="modal" data-backdrop="false"><?php _e('Reject'); ?></a>'
                        + '</ul></div>' + content;
            }
            $('#article-management-operation').html(content);
        }
    }
});
var ReleaseProcess = Backbone.View.extend({
    template    : "",
    el          : $("#jsReleaseProcess"),
    events      : {
        "click .save"       : "save",
        "click .preview"    : "preview",
        "click .reject"     : "reject",
        "click .pending"    : "pending",
        "click .delete"     : "deleteArticle",
        "click .approve"    : "approve",
        "click .update"     : "update",
        "click .edit-time"  : "popupTime",
        "click .save-time"  : "saveTime",
        "click .cancel-time": "cancelTime"
    },
    initialize  : function() {
        $("#datepicker").datepicker({
            format   : "yyyy-mm-dd",
            language : "zh-CN"
        });
    },
    save        : function() {
         page.submit();
    },
    reject      : function() {
        var val = $.trim(this.$(".memo").val()),
            btn = this.$(".reject");
        if (val) {
            btn.attr("disabled","disabled");  
            $.getJSON(
                "<?php echo $this->url('', array('action' => 'reject')); ?>",
                {
                    id      : page.id,
                    memo    : val   
                }
            ).done(function(resp) {
                if (resp.status == 1) {
                    history.go(-1);
                } else {
                   btn.removeAttr("disabled");
                }
            });
        }
    },
    preview : function () {
        page.submit({fn : function(data) {
            if (data.preview_url) {
                $("#jsAlert").remove();
                page.$(".hide-preview").attr("href", data.preview_url)[0].click(); 
            } else {
                page.formTip({status:0,message:"The url is not exists, please try again!"});
            }
        }});
    },
    pending : function () {
        var self = this,
            btn  = this.$(".pending");
            obj  = btn.clone();
        btn.attr("disabled","disabled");
        page.submit({
            url : "<?php echo $this->url('', array('action' => 'publish')); ?>",
            fn  : function(resp) {
                response      = resp;
                currentStatus = 2;
                self.$(".status").html(resp.status);
                var approve  = '<?php echo implode(',', $approve); ?>';
                var approves = new Array;
                approves = approve.split(',');
                var category = $('select[name="category"]').val();
                var allowed  = false;
                for (i = 0; i < approves.length; i++) {
                    if (category == approves[i]) {
                        allowed = true;
                    }
                }
                if (!allowed) {
                    btn.remove();
                } else {
                    btn.removeAttr("disabled").html(resp.btn_value).removeClass("pending").addClass("approve");
                    $('input[name="time_submit"]').val(resp.time_submit);
                }
                var approveDelete  = '<?php echo implode(',', $delete); ?>';
                var approveDeletes = new Array;
                approveDeletes = approveDelete.split(',');
                var deleteAllowed = false;
                for (i = 0; i < approveDeletes.length; i++) {
                    if (category == approveDeletes[i]) {
                        deleteAllowed = true;
                    }
                }
                if (!deleteAllowed) {
                    $('span.delete').remove();
                }
            },
            fail    : function() {
                btn.removeAttr("disabled");
            }
        });
    },
    deleteArticle   : function () {
        if (confirm("<?php _e('Are you sure delete this article?'); ?>")) {
           <?php if ($draft['article']) { ?>
           location.href = "<?php echo $this->url('', array(
               'controller' => 'article',
               'action'     => 'delete',
               'id'         => $draft['article'],
               'source'     => 'my',
           )); ?>" + "?from=" + encodeURIComponent(document.referrer);
           <?php } else { ?>
           location.href = "<?php echo $this->url('', array(
               'controller' => 'draft',
               'action'     => 'delete',
               'source'     => 'my',
           )); ?>" + "?id=" + page.id + "&from=" + encodeURIComponent(document.referrer);    
           <?php } ?>        
        }
    },
    approve : function () {
        var btn = this.$(".approve").attr("disabled","disabled");
        page.submit({
            url  : "<?php echo $this->url('', array('action' => 'approve')); ?>",
            fn   : function() {
               $("#jsAlert a").remove();
            },
            fail : function() {
                btn.removeAttr("disabled");
            }   
        });
    },
    update  :   function() {
        var btn = this.$(".update").attr("disabled","disabled");
        page.submit({
            url  : "<?php echo $this->url('', array('action' => 'update')); ?>" ,
            fn   : function() {
                $("#jsAlert a").remove();
            },
            fail : function() {
                btn.removeAttr("disabled");
            } 
        });
    },
    popupTime   : function() {
        var el = this.$(".article-flow"),
            p  = $("#datepicker"),
            t  = new Date;
            el.addClass("editing");
            this.$(".time-edit-wrap").removeClass("hide");
            p.data("datepicker").setValue();
            p.data("datepicker").show();
            this.$(".text-hour").val(t.getHours());
            this.$(".text-minute").val(t.getMinutes());
            
            // @Temporary measure: change the icon
            var prev = $("th.prev").children();
            var next = $("th.next").children();
            prev.each(function() {
                var e = $(this);
                e.removeClass("icon-arrow-left");
                e.addClass("fa fa-chevron-left");
            });
            next.each(function() {
                var e = $(this);
                e.removeClass("icon-arrow-right");
                e.addClass("fa fa-chevron-right");
            });
    },
    saveTime    : function() {
        var s  = "Scheduled at ",
            s1 = $("#datepicker").val()
               + " " + this.$(".text-hour").val()
               + ":" + this.$(".text-minute").val();
        s += '<strong>' + s1 + '</strong>';
        this.$(".publish-time-edit").html(s);
        $("[name=time_publish]").val(s1);
        this.cancelTime();
    },
    cancelTime  : function() {
        this.$(".article-flow").removeClass("editing");  
    }
});
var AttachmentView = Backbone.View.extend({
    el          : $("#attachment-image-element"),
    events      : {
        "click .image-thumb .remove-item" : "removeFromEditor",
        "click .image-thumb .attachment"  : "insertEditor"
    },
    initialize: function () {},
    removeFromEditor    : function (e) {
        if (confirm("<?php _e('This operation will also remove attachment in editor, do you still want to continue?'); ?>")) {
            var el = $(e.target).parents(".selected-item");
            $(page.editor.document.getBody().$).find("a[href='" + el.data("download") + "']").remove();
        }
    },
    insertEditor        : function (e) {
        var el = $(e.target).parents(".selected-item");
        var html = '<a href="' + el.data("download") + '">' + el.find(".attachment").attr("title") + '</a>';
        page.editor.insertHtml(html);
    }
});
var GalleryView = Backbone.View.extend({
    el          : $("#gallery-image-element"),
    events      : {
        "click .image-thumb .remove-item" : "removeFromEditor",
        "click .image-thumb img"          : "insertEditor"
    },
    initialize: function () {},
    removeFromEditor    : function (e) {
        if (confirm("<?php _e('This operation will also remove image in editor, do you still want to continue?'); ?>")) {
            var el = $(e.target).parents(".selected-item");
            $(page.editor.document.getBody().$).find("a[href='" + el.data("download") + "']").remove();
        }
    },
    insertEditor        : function (e) {
        var el = $(e.target).parents(".selected-item");
        var html = '<a href="' + el.data("download") + '" target="_blank"><img alt="' + el.find("img").attr("title") + '" src="' + el.find("img").attr("src") + '"></a>';
        page.editor.insertHtml(html);
    }
});

page.init();
new BasicInputView;
new ReleaseProcess;
new AttachmentView;
new GalleryView;
})(jQuery)
</script>
